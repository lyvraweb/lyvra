<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>App — Lyvra</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Bem-vindo ao Lyvra</h1>

<p id="user-plan">Carregando...</p>

<button id="generateBtn">Gerar conteúdo</button>
<button id="upgradeBtn">Upgrade</button>
<button id="managePlanBtn" style="display:none;">Gerenciar assinatura</button>
<button id="logoutBtn">Sair</button>

<div id="result" style="display:none;">
  <p><strong>Ideia:</strong> <span id="ideaText"></span></p>
  <p><strong>Legenda:</strong> <span id="copyText"></span></p>
  <img id="imagePreview" width="300">
  <div id="watermark" style="display:none;">Criado com Lyvra AI</div>
</div>

<div class="upgrade" id="upgradeBox" style="display:none;">
  Você está no plano Free. Faça upgrade para liberar mais recursos.
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBzFp2tWWFzXD1bfEJ3TmtdnYTnXgphENc",
  authDomain: "lyvra-e48a0.firebaseapp.com",
  projectId: "lyvra-e48a0"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ================= LIMITES ================= */
const limits = {
  free: 3,
  pro: 300,
  business: Infinity
};

/* ================= ELEMENTOS ================= */
const userPlanEl  = document.getElementById("user-plan");
const generateBtn = document.getElementById("generateBtn");
const upgradeBtn  = document.getElementById("upgradeBtn");
const logoutBtn   = document.getElementById("logoutBtn");
const upgradeBox  = document.getElementById("upgradeBox");
const watermarkEl = document.getElementById("watermark");
const manageBtn   = document.getElementById("managePlanBtn");
const resultBox   = document.getElementById("result");

/* ================= ESTADO ================= */
let CURRENT_UID = null;
let CURRENT_PLAN = "free";
let USED = 0;
let LIMIT = 0;
let USAGE_KEY = null;

/* ================= AUTH ================= */
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    window.location.replace("/login.html");
    return;
  }

  CURRENT_UID = user.uid;
  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();

  if (!snap.exists) {
    await ref.set({ plan: "free" });
  }

  listenUserPlan(user.uid);
});

/* ================= PLANO EM TEMPO REAL ================= */
function listenUserPlan(uid) {
  const ref = db.collection("users").doc(uid);

  ref.onSnapshot((doc) => {
    if (!doc.exists) return;

    const plan = doc.data().plan || "free";
    applyPlanUI(uid, plan);
  });
}

/* ================= UI ================= */
function applyPlanUI(uid, plan) {
  CURRENT_PLAN = plan;
  LIMIT = limits[plan];

  const monthKey = new Date().toISOString().slice(0, 7);
  USAGE_KEY = `usage_${uid}_${monthKey}`;
  USED = parseInt(localStorage.getItem(USAGE_KEY)) || 0;

  userPlanEl.innerText =
    `Plano ${plan.toUpperCase()} • ${USED}/${LIMIT === Infinity ? "∞" : LIMIT}`;

  const isFree = plan === "free";

  upgradeBtn.style.display  = isFree ? "inline-block" : "none";
  upgradeBox.style.display  = isFree ? "block" : "none";
  watermarkEl.style.display = isFree ? "block" : "none";
  manageBtn.style.display   = isFree ? "none" : "inline-block";

  updateGenerateButton();
}

/* ================= GERAR ================= */
generateBtn.onclick = () => {
  if (USED >= LIMIT) return;

  USED++;
  localStorage.setItem(USAGE_KEY, USED);

  resultBox.style.display = "block";
  userPlanEl.innerText =
    `Plano ${CURRENT_PLAN.toUpperCase()} • ${USED}/${LIMIT === Infinity ? "∞" : LIMIT}`;

  updateGenerateButton();
};

/* ================= CONTROLE ================= */
function updateGenerateButton() {
  if (USED >= LIMIT) {
    generateBtn.disabled = true;
    generateBtn.innerText = "Limite atingido";
  } else {
    generateBtn.disabled = false;
    generateBtn.innerText = "Gerar conteúdo";
  }
}

/* ================= BOTÕES ================= */
logoutBtn.onclick = async () => {
  await auth.signOut();
  window.location.replace("/login.html");
};

upgradeBtn.onclick = () => {
  window.location.href = "/planos.html";
};

manageBtn.onclick = async () => {
  const res = await fetch("/api/create-portal-session", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ uid: CURRENT_UID })
  });

  const data = await res.json();
  if (data.url) window.location.href = data.url;
};
</script>
</body>
</html>
