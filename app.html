<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>App — Lyvra</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Bem-vindo ao Lyvra</h1>

<p id="user-plan">Carregando...</p>

<button id="generateBtn">Gerar conteúdo</button>
<button id="upgradeBtn">Upgrade</button>
<button id="managePlanBtn" style="display:none;">Gerenciar assinatura</button>
<button id="logoutBtn">Sair</button>

<div id="result" style="display:none;">
  <p><strong>Ideia:</strong> <span id="ideaText"></span></p>
  <p><strong>Legenda:</strong> <span id="copyText"></span></p>
  <img id="imagePreview" width="300">
  <div id="watermark" style="display:none;">Criado com Lyvra AI</div>
</div>

<div class="upgrade" id="upgradeBox" style="display:none;">
  Você está no plano Free. Faça upgrade para liberar mais recursos.
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ================= FIREBASE ================= */
  firebase.initializeApp({
    apiKey: "AIzaSyBzFp2tWWFzXD1bfEJ3TmtdnYTnXgphENc",
    authDomain: "lyvra-e48a0.firebaseapp.com",
    projectId: "lyvra-e48a0"
  });

  const auth = firebase.auth();
  const db   = firebase.firestore();

  /* ================= LIMITES ================= */
  const limits = {
    free: 3,
    pro: 300,
    business: Infinity
  };

  /* ================= ELEMENTOS ================= */
  const userPlanEl   = document.getElementById("user-plan");
  const watermarkEl  = document.getElementById("watermark");
  const upgradeBox   = document.getElementById("upgradeBox");
  const upgradeBtn   = document.getElementById("upgradeBtn");
  const manageBtn    = document.getElementById("managePlanBtn");
  const generateBtn  = document.getElementById("generateBtn");
  const resultBox    = document.getElementById("result");

  /* ================= ESTADO GLOBAL ================= */
  let UID = null;
  let PLAN = "free";
  let USED = 0;
  let LIMIT = limits.free;
  let USAGE_KEY = null;

  /* ================= AUTH ================= */
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    window.location.replace("/login.html");
    return;
  }

  CURRENT_UID = user.uid;

  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();

  if (!snap.exists) {
    await ref.set({
      plan: "free",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  listenUserPlan(user.uid);
});
  
  /* ================= FIRESTORE REALTIME ================= */
  function subscribeUserDoc() {
    db.collection("users").doc(UID).onSnapshot(doc => {
      const data = doc.exists ? doc.data() : { plan: "free" };
      applyPlan(data.plan || "free");
    });
  }

  /* ================= APLICA PLANO ================= */
  function applyPlan(plan) {
    PLAN = plan;
    LIMIT = limits[PLAN];

    const monthKey = new Date().toISOString().slice(0, 7);
    USAGE_KEY = `usage_${UID}_${monthKey}`;
    USED = parseInt(localStorage.getItem(USAGE_KEY)) || 0;

    userPlanEl.innerText =
      `Plano ${PLAN.toUpperCase()} • ${USED}/${LIMIT === Infinity ? "∞" : LIMIT}`;

    const isFree = PLAN === "free";

    watermarkEl.style.display = isFree ? "block" : "none";
    upgradeBox.style.display  = isFree ? "block" : "none";
    upgradeBtn.style.display  = isFree ? "inline-block" : "none";
    manageBtn.style.display   = isFree ? "none" : "inline-block";

    updateGenerateButton();
  }

  /* ================= GERAR ================= */
  generateBtn.addEventListener("click", () => {
    if (USED >= LIMIT) return;

    USED++;
    localStorage.setItem(USAGE_KEY, USED);

    document.getElementById("ideaText").innerText = "Ideia gerada com IA";
    document.getElementById("copyText").innerText = "Legenda persuasiva";
    document.getElementById("imagePreview").src =
      "https://via.placeholder.com/600";

    resultBox.style.display = "block";

    userPlanEl.innerText =
      `Plano ${PLAN.toUpperCase()} • ${USED}/${LIMIT === Infinity ? "∞" : LIMIT}`;

    updateGenerateButton();
  });

  function updateGenerateButton() {
    if (USED >= LIMIT) {
      generateBtn.disabled = true;
      generateBtn.innerText = "Limite atingido";
    } else {
      generateBtn.disabled = false;
      generateBtn.innerText = "Gerar conteúdo";
    }
  }

  /* ================= BOTÕES ================= */
  document.getElementById("logoutBtn").onclick = async () => {
    await auth.signOut();
    window.location.replace("/login.html");
  };

  upgradeBtn.onclick = () => {
    window.location.href = "/planos.html";
  };

  manageBtn.onclick = async () => {
    const res = await fetch("/api/create-portal-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid: UID })
    });

    const data = await res.json();
    if (data.url) window.location.href = data.url;
  };

});
</script>
</body>
</html>
