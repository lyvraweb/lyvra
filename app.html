<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>App — Lyvra</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Bem-vindo ao Lyvra</h1>

<p id="user-plan">Carregando...</p>

<button id="generateBtn">Gerar conteúdo</button>
<button id="upgradeBtn">Upgrade</button>
<button id="logoutBtn">Sair</button>

<div id="result" style="display:none;">
  <p><strong>Ideia:</strong> <span id="ideaText"></span></p>
  <p><strong>Legenda:</strong> <span id="copyText"></span></p>
  <img id="imagePreview" width="300">
  <div id="watermark" style="display:none;">Criado com Lyvra AI</div>
</div>

<div class="upgrade" id="upgradeBox" style="display:none;">
  Você está no plano Free. Faça upgrade para liberar mais recursos.
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBzFp2tWWFzXD1bfEJ3TmtdnYTnXgphENc",
  authDomain: "lyvra-e48a0.firebaseapp.com",
  projectId: "lyvra-e48a0"
});

const auth = firebase.auth();
const db   = firebase.firestore();

/* ================= LIMITES ================= */
const limits = {
  free: 3,
  pro: 300,
  business: Infinity
};

/* ================= ELEMENTOS ================= */
const userPlanEl  = document.getElementById("user-plan");
const watermarkEl = document.getElementById("watermark");
const upgradeBox  = document.getElementById("upgradeBox");
const upgradeBtn = document.getElementById("upgradeBtn");
const generateBtn = document.getElementById("generateBtn");
const resultBox   = document.getElementById("result");

/* ================= ESTADO ================= */
let CURRENT_PLAN = "free";
let CURRENT_UID  = null;
let USED         = 0;
let LIMIT        = 0;
let USAGE_KEY    = null;

/* ================= AUTH ================= */
auth.onAuthStateChanged((user) => {
  if (!user) {
    window.location.replace("/login.html");
    return;
  }

  CURRENT_UID = user.uid;
  listenUserPlan(CURRENT_UID);
});

/* ================= ESCUTA PLANO (REALTIME) ================= */
function listenUserPlan(uid) {
  const ref = db.collection("users").doc(uid);

  ref.onSnapshot(async (doc) => {
    let plan = "free";

    if (doc.exists && doc.data().plan) {
      plan = doc.data().plan;
    } else {
      await ref.set({ plan: "free" }, { merge: true });
    }

    applyPlanUI(uid, plan);
  });
}

/* ================= APLICA UI ================= */
function applyPlanUI(uid, plan) {
  CURRENT_PLAN = plan;
  LIMIT = limits[plan];

  const monthKey = new Date().toISOString().slice(0, 7);
  USAGE_KEY = `usage_${uid}_${monthKey}`;

  USED = parseInt(localStorage.getItem(USAGE_KEY)) || 0;

  userPlanEl.innerText =
    `Plano ${plan.toUpperCase()} • ${USED}/${LIMIT === Infinity ? "∞" : LIMIT}`;

  watermarkEl.style.display = plan === "free" ? "block" : "none";
  const isFree = plan === "free";

upgradeBox.style.display  = isFree ? "block" : "none";
upgradeBtn.style.display  = isFree ? "inline-block" : "none";


  updateGenerateButton();
}

/* ================= GERAR ================= */
generateBtn.onclick = () => {
  if (USED >= LIMIT) return;

  USED++;
  localStorage.setItem(USAGE_KEY, USED);

  document.getElementById("ideaText").innerText = "Ideia gerada com IA";
  document.getElementById("copyText").innerText = "Legenda persuasiva";
  document.getElementById("imagePreview").src =
    "https://via.placeholder.com/600";

  resultBox.style.display = "block";

  userPlanEl.innerText =
    `Plano ${CURRENT_PLAN.toUpperCase()} • ${USED}/${LIMIT === Infinity ? "∞" : LIMIT}`;

  updateGenerateButton();
};

/* ================= BOTÃO ================= */
function updateGenerateButton() {
  if (USED >= LIMIT) {
    generateBtn.disabled = true;
    generateBtn.innerText = "Limite atingido";
  } else {
    generateBtn.disabled = false;
    generateBtn.innerText = "Gerar conteúdo";
  }
}

/* ================= BOTÕES AUX ================= */
document.getElementById("logoutBtn").onclick = async () => {
  await auth.signOut();
  window.location.replace("/login.html");
};

document.getElementById("upgradeBtn").onclick = () => {
  window.location.href = "/planos.html";
};
</script>

</body>
</html>
