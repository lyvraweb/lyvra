<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>App — Lyvra</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Bem-vindo ao Lyvra</h1>
<p id="status">Carregando...</p>
<button id="logout">Sair</button>
<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBzFp2tWWFzXD1bfEJ3TmtdnYTnXgphENc",
  authDomain: "lyvra-e48a0.firebaseapp.com",
  projectId: "lyvra-e48a0"
});

const auth = firebase.auth();
const db   = firebase.firestore();

/* ================= ELEMENTOS ================= */
const statusEl = document.getElementById("user-plan");
const logoutBtn = document.getElementById("logoutBtn");

/* ================= AUTH ================= */
auth.onAuthStateChanged(async (user) => {

  if (!user) {
    window.location.replace("/login.html");
    return;
  }

  try {
    const uid = user.uid;
    const userRef = db.collection("users").doc(uid);
    const snap = await userRef.get();

    let data;

    if (!snap.exists) {
      data = {
        email: user.email,
        name: user.displayName || "",
        plan: "free",
        usageCount: 0,
        usageMonth: getCurrentMonth(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await userRef.set(data);
    } else {
      data = snap.data();
    }

    initApp(data);

  } catch (err) {
    console.error("Erro ao carregar usuário:", err);
    statusEl.innerText = "Erro ao carregar conta";
  }
});

/* ================= APP ================= */
function initApp(user) {
  statusEl.innerText = `Plano ${user.plan.toUpperCase()}`;
}

/* ================= LOGOUT ================= */
logoutBtn.addEventListener("click", async () => {
  await auth.signOut();
  window.location.replace("/login.html");
});

/* ================= UTILS ================= */
function getCurrentMonth() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
}
</script>
</body>
</html>
