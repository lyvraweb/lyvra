<!doctype html>
<html lang="pt-BR">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Painel — Lyvra</title></head>
<body>
  <main class="container">
    <h1>Painel Lyvra</h1>
    <p id="welcome">Carregando usuário...</p>
    <div id="controls" style="display:none;">
      <p>Seu plano: <span id="user-plan">—</span></p>
      <p>Gerações usadas este mês: <span id="used">0</span></p>
      <button id="generate">Gerar conteúdo</button>
      <button id="upgrade">Upgrade</button>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
    apiKey: "AIzaSyBzFp2tWWFzXD1bfEJ3TmtdnYTnXgphENc",
    authDomain: "lyvra-e48a0.firebaseapp.com",
    projectId: "lyvra-e48a0",
    storageBucket: "lyvra-e48a0.firebasestorage.app",
    messagingSenderId: "1022305501638",
    appId: "1:1022305501638:web:05d299b9a235189c2bb2c7",
    measurementId: "G-EYHVTSZYPX"
  };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      auth.onAuthStateChanged(async user => {
        if(!user) {
          window.location.href = '/planos.html';
          return;
        }
        document.getElementById('welcome').innerText = 'Olá, ' + (user.displayName || user.email);
        // fetch user doc
        const docRef = db.collection('users').doc(user.uid);
        const doc = await docRef.get();
        let plan = 'free';
        let used = 0;
        if(doc.exists) {
          const data = doc.data();
          plan = data.plan || 'free';
          used = data.used || 0;
        } else {
          // create default record
          await docRef.set({ plan: 'free', used: 0 });
        }
        document.getElementById('user-plan').innerText = plan;
        document.getElementById('used').innerText = used;
        document.getElementById('controls').style.display = 'block';

        // apply quota limit for free
        const limit = plan === 'free' ? 3 : (plan === 'pro' ? 300 : 999999);
        document.getElementById('generate').addEventListener('click', async () => {
          if(used >= limit) return alert('Limite atingido para seu plano. Faça upgrade.');
          // create a generation request in Firestore (Make or serverless will process)
          await db.collection('generations').add({ uid: user.uid, status: 'queued', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          await docRef.update({ used: firebase.firestore.FieldValue.increment(1) });
          alert('Geração solicitada. Será entregue em breve.');
          document.getElementById('used').innerText = used + 1;
        });
        document.getElementById('upgrade').addEventListener('click', () => {
          window.location.href = '/checkout.html?plan=pro';
        });
      });
    </script>
  </main>
</body>
</html>
