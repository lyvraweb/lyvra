<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>App — Lyvra</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Bem-vindo ao Lyvra</h1>
<p id="user-plan">Carregando...</p>
<button id="logoutBtn">Sair</button>
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ================= FIREBASE ================= */
  firebase.initializeApp({
    apiKey: "AIzaSyBzFp2tWWFzXD1bfEJ3TmtdnYTnXgphENc",
    authDomain: "lyvra-e48a0.firebaseapp.com",
    projectId: "lyvra-e48a0"
  });

  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ================= LIMITES ================= */
  const limits = { free: 3, pro: 300, business: Infinity };

  /* ================= AUTH ================= */
  auth.onAuthStateChanged(async (user) => {

    if (!user) {
      window.location.href = "/login.html";
      return;
    }

    const uid = user.uid;
    const ref = db.collection("users").doc(uid);
    const snap = await ref.get();

    let plan = "free";

    if (snap.exists) {
      plan = snap.data().plan || "free";
    } else {
      await ref.set({ plan: "free" });
    }

    initApp(uid, plan);
  });

  function initApp(uid, plan) {
    const usageKey = `usage_${uid}_${new Date().getMonth()}`;
    let used = parseInt(localStorage.getItem(usageKey)) || 0;
    const limit = limits[plan];

    const userPlanEl = document.getElementById("user-plan");
    const watermark = document.getElementById("watermark");
    const result = document.getElementById("result");

    userPlanEl.innerText =
      `Plano ${plan.toUpperCase()} • ${used}/${limit === Infinity ? "∞" : limit}`;

    watermark.style.display = plan === "free" ? "block" : "none";

    document.getElementById("generateBtn").onclick = () => {
      if (used >= limit) return;

      used++;
      localStorage.setItem(usageKey, used);

      document.getElementById("ideaText").innerText = "Ideia gerada com IA";
      document.getElementById("copyText").innerText = "Legenda persuasiva";
      document.getElementById("imagePreview").src =
        "https://via.placeholder.com/600";

      result.style.display = "block";
      userPlanEl.innerText =
        `Plano ${plan.toUpperCase()} • ${used}/${limit === Infinity ? "∞" : limit}`;
    };
  }

  /* ================= BOTÕES ================= */
  document.getElementById("logoutBtn").onclick = () => auth.signOut();
  document.getElementById("upgradeBtn").onclick = () => location.href = "/planos.html";

});
</script>
</body>
</html>
